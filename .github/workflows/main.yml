name: clone

on:
  schedule:
    - cron: 1 1 1 1 1
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - userName: RedLightsDistrict
            repoName: Bncr_plugins
            branchName: main
          - userName: Yuheng0101
            repoName: Bncr_plugins
            branchName: main
    steps:
      - name: Checkout master
        uses: actions/checkout@master
      - name: Check New Commit
        run: |
          upStream=https://github.com/${{ matrix.userName }}/${{ matrix.repoName }}
          echo "upStream=$upStream" >> $GITHUB_ENV
          commit=$(curl -sL $upStream/commits/${{ matrix.branchName }} |grep -o "/${{ matrix.userName }}/${{ matrix.repoName }}/commit/[a-z0-9]\+" |head -1 | cut -d\/ -f5)
          if ! grep -q "$commit" README.md || [ "${{ inputs.rebuild }}" == "true" ]; then
            echo "commit=$commit" >> $GITHUB_ENV
            echo "commitS=${commit:0:7}" >> $GITHUB_ENV
          fi

      - name: Push to master
        if: ${{ env.commit }}
        run: |
          curl -O https://github.com/Yuheng0101/Bncr_plugins/raw/main/影视搜索.js
          curl -O https://github.com/Yuheng0101/Bncr_plugins/raw/main/汇总.js
          curl -O https://github.com/Yuheng0101/Bncr_plugins/raw/main/汇总.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/Bncr_SPY.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/京东口令解析url.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/奶酪.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/查询.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/消息转发.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/登录.js
          curl -O https://github.com/RedLightsDistrict/Bncr_plugins/raw/main/自建sign.js
          git config --global credential.helper store
          git config user.name github-actions
          git config user.email github-actions@github.com

          sed -i "/${{ matrix.userName }}\/${{ matrix.repoName }}/s#Updated: [a-zA-Z0-9]*#Updated: ${{ env.commit }}#" README.md
          git add --all
          git commit -m "${{ env.commit }}"
          git push -u -f origin main     
